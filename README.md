**English version below**

Road Signs Detector
===
Мобильное приложение для Android. Распознаёт и называет дорожные знаки.

Данное приложение является демонстрационным. Его задача - продемонстрировать возможность распознавания в реальном времени широкого класса дорожных знаков с высокой точностью при помощи обычного смартфона.

Демонстрация работы приложения
---
Нажмите на кнопку для просмотра видео.

<a href="http://www.youtube.com/watch?feature=player_embedded&v=ZUI4KG97Mwk
" target="_blank"><img src="https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/imgs/preview.png" 
alt="Демонстрация работы приложения" width="640" height="360" border="10" /></a>

Лицензия
---
Данный материал представляется на условиях [Публичная лицензия Creative Commons С указанием авторства-Некоммерческая версии 4.0 Международная"](https://creativecommons.org/licenses/by-nc/4.0/legalcode.ru).

Как запустить
---
Скачайте файл [RoadSignsDetector.apk](https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/bin/RoadSignsDetector.apk) из папки bin и установите его на мобильном приложении.

Принцип работы
---
Распознавание осуществляется в несколько этапов:
1. На входной картинке осуществляется поиск знаков. На данном этапе знаки не классифицируются.
2. Производится классификация найденных знаков.
3. Информация о найденных знаках дополнительно обрабатывается. Например, для того, чтобы окончательно считать, что знак обнаружен, нужно, чтобы за последние несколько кадров не менее определённой доли кадров содержало данный знак. Количество кадров, принимаемых в расчёт, зависит от скорости обработки кадров. Конкретные значения настроечных параметров указаны в файле [Config.java](https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/app/src/main/java/com/android/roadsignsdetector/Config.java).
4. После окончательного обнаружения знака он добавляется в очередь на произнесение. Если в текущий момент произносится другой знак, то данный знак будет произнесён после окончания произнесения предыдущих добавленных в очередь знаков.

Распознаваемые знаки
---
<img src="https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/imgs/signs.png" alt="Detected signs"/>

**Примечания:**

* Знаки, обведённые в каждую рамку, распознаются как один класс.
* Нейросеть также распознаёт отдельный класс «прочее», означающий отсутствие какого-либо из данных знаков.
* Всего нейросеть распознаёт 29 классов.
* Знак ограничения скорости 90 км/ч на чёрном фоне - это знак ограничения скорости, отображаемый на электронном табло. Он был добавлен для эксперимента. Этот знак распознаётся как отдельный класс. Но на этапе постобработки отображается в класс обычного знака ограничения скорости 90 км/ч. См. [Config.java#L36](https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/app/src/main/java/com/android/roadsignsdetector/Config.java#L36).

Подбор параметров
---
Настроечные параметры алгоритма содержатся в файле [Config.java](https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/app/src/main/java/com/android/roadsignsdetector/Config.java).

Подбор этих параметров осуществлялся при помощи эмулирования работы приложения на проверочном видео и анализа результатов его работы.

Длительность проверочного видео составила 1:31:56. Проверочное видео содержит запись езды по городу летом. Время суток - преимущественно светлое, но примерно за 20-25 минут до окончания видео наблюдается закат, после чего начинает немного темнеть. Погодные условия на проверочном видео - в первой части видео хорошие. За 20 минут до окончания начинается небольшой дождь.

Проверочное видео было вручную размечено – были определены интервалы присутствия и отсутствия определяемых знаков. Некоторые интервалы размечались как «неопределённые». При обнаружении знака в этот интервал это не считалось ни ошибкой, ни отсутствием ошибки. Например, когда знак вроде бы виден, но ещё слишком далеко. Или когда видна часть знака.

Всего было размечено 1149 фрагментов общей длительностью 5 ч 30 мин. Из них около 12 мин - присутствие, 4 ч 51 мин - отсутствие, 26 мин - неопределённость.

Точность распознавания
---
При подобранных параметрах на проверочном видео было зафиксировано 51 ошибок (в среднем 0,57 ошибок в минуту). Из них 42 ошибки (в среднем 0,47 ошибок в минуту) - необнаружение присутствующего знака (ошибка второго рода) и 9 ошибок (в среднем 0,10 ошибок в минуту) - обнаружение несуществующего знака (ошибка первого рода).

Выбор архитектуры нейросетей
---
Для нейросети, осуществляющей поиск объектов, была выбрана архитектура yolov5 как одна из лучших на момент обучения по соотношению качество/скорость.

Среди подвариантов был выбран вариант yolov5s, поскольку он показал наилучшую точностью и одновременно наилучшую скорость работы.

Для нейросети, осуществляющией классификацию знаков, была проверено несколько разных архитектур на базе свёрточных сетей. После обучения была выбран вариант, дающий почти рекордную точность при высокой скорости.

Подход к обучению нейросетей
---
Для обучения нейросетей были размечены знаки на 1576 кадрах (не из проверочного видео). 

Нейросеть, осуществляющая обнаружение объектов, была обучена на этих данных. Причём в обучающем датасете все знаки были указаны как один класс.

Для обучения нейросети, осуществляющей классификацию, исходные данные разбивались на обучающую и проверочную выборки. Затем для выравнивания размеров классов при помощи аугментации для каждого класса генерировались по 10000 обучающих изображений и 1000 проверочных. После чего выполнялось обучение. Отдельно искусственно создавался класс «прочее», в который брались различные фрагменты, не пересекающиеся с размеченными фрагментами знаков.

Квантование
---
Для оптимизации скорости инференса на мобильном приложении нейросети были квантованы.

Для нейросети, осуществляющей классификацию, было также выполнено дообучение с применением техники Quantization Aware Training.

Результаты обучения нейросетей
---
### Object detection
* Precision: 0.968
* Recall: 0.983
* mAP@.5: 0.993
* mAP@.5:.95: 0.904

См. также [приложение](#appendix--приложение).

### Classification
* Accuracy до квантизации: 0.99831
* Accuracy после квантизации: 0.99893

Дальнейшее развитие проекта
---
Для увеличения количества поддерживаемых знаков необходимо выполнить разметку новых знаков и переобучить нейронную сеть.

Для увеличения точности распознавания необходимо разметить больше дорожных знаков и переобучить нейронную сеть. Также хороший эффект даст обучение нейросети на большем количестве примеров, на которых текущая версия делает ошибки.

Тесты
---
На текущий момент приложение проверено только на Redmi Note 9 (MIUI Global 12.0.7).

Как скомпилировать
---
1. Скачать проект
2. Открыть проект в Android Studio
3. Изменить настройки в файлах gradle.properties, local.properties
4. Скомпилировать

Для стабильности компиляции репозиторий содержит директорию с исходными кодами библиотеки openCV.

Контакты автора
---
По всем вопросам и предложениям обращайтесь на email: 

ivankrylatskoe@gmail.com

Appendix / Приложение
---
Характеристики нейросети, осуществляющей обнаружение объектов.

Object detection neural network characteristics.

<img src="https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/imgs/object_detection_F1_curve.png" alt="F1 curve" width="640"/>
<img src="https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/imgs/object_detection_P_curve.png" alt="P curve" width="640"/>
<img src="https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/imgs/object_detection_PR_curve.png" alt="P curve" width="640"/>
<img src="https://github.com/ivankrylatskoe/RoadSignsDetector/blob/main/imgs/object_detection_R_curve.png" alt="P curve" width="640"/>

